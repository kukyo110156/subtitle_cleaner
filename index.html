<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日文字幕清洗工具</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Noto Sans TC', 'Noto Sans JP', sans-serif;
            background-color: #f1f5f9; /* Slate-100 */
        }
        .japanese-text {
            font-family: 'Noto Sans JP', sans-serif;
            line-height: 1.8;
        }
        
        /* Custom Scrollbar */
        textarea::-webkit-scrollbar {
            width: 6px;
        }
        textarea::-webkit-scrollbar-track {
            background: transparent;
        }
        textarea::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        /* Toggle Switch Styling */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #6366f1;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #6366f1;
        }

        /* Drag Overlay */
        .drag-overlay {
            background: rgba(99, 102, 241, 0.05); /* Indigo tint */
            border: 2px dashed #6366f1;
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-700">

    <!-- Header (Compact) -->
    <header class="bg-white border-b border-slate-200 px-6 py-3 flex justify-between items-center shrink-0 z-10 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-indigo-600 text-white p-1.5 rounded-lg">
                <i data-lucide="file-text" class="w-5 h-5"></i>
            </div>
            <h1 class="text-lg font-bold text-slate-800">日文字幕清洗工具</h1>
        </div>
        
        <div class="flex items-center gap-3">
            <button id="clearBtn" class="text-slate-500 hover:text-red-500 text-sm font-medium flex items-center gap-1 px-3 py-1.5 rounded-md hover:bg-slate-50 transition-colors">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
                清空
            </button>
            <label class="cursor-pointer bg-indigo-50 hover:bg-indigo-100 text-indigo-600 text-sm font-medium px-4 py-1.5 rounded-md transition-colors flex items-center gap-2 border border-indigo-100">
                <i data-lucide="folder-open" class="w-4 h-4"></i>
                <span>開啟檔案</span>
                <input type="file" id="fileInput" accept=".txt,.srt,.vtt,.ass" class="hidden">
            </label>
        </div>
    </header>

    <!-- Main Content (Dual Pane) -->
    <main class="flex-1 flex flex-col md:flex-row min-h-0 overflow-hidden">
        
        <!-- Left Pane: Input -->
        <div class="flex-1 flex flex-col border-r border-slate-200 bg-white min-w-0 relative group">
            <!-- Pane Header -->
            <div class="px-5 py-3 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <span class="text-sm font-semibold text-slate-600 flex items-center gap-2">
                    <i data-lucide="arrow-right-circle" class="w-4 h-4 text-indigo-400"></i>
                    原始內容
                </span>
                <span class="text-xs text-slate-400">支援拖曳上傳</span>
            </div>

            <!-- Text Area Container -->
            <div class="relative flex-1" id="dropZone">
                <textarea id="inputArea" class="japanese-text w-full h-full p-5 resize-none focus:outline-none text-slate-700 placeholder-slate-300 text-base" placeholder="請將字幕檔拖曳至此，或直接貼上文字..."></textarea>
                
                <!-- Drag Overlay (Hidden by default) -->
                <div id="dragOverlay" class="absolute inset-2 rounded-lg drag-overlay hidden flex-col items-center justify-center pointer-events-none z-10 backdrop-blur-[1px]">
                    <i data-lucide="download-cloud" class="w-10 h-10 text-indigo-500 mb-2 animate-bounce"></i>
                    <span class="font-bold text-indigo-600">放開以讀取檔案</span>
                </div>

                <!-- Loading -->
                <div id="loadingIndicator" class="absolute inset-0 bg-white/90 hidden flex-col items-center justify-center z-20">
                    <i data-lucide="loader-2" class="w-8 h-8 text-indigo-600 animate-spin mb-2"></i>
                    <span class="text-sm text-indigo-600 font-medium">讀取中...</span>
                </div>
            </div>

            <!-- Left Footer: Controls -->
            <div class="p-4 bg-slate-50 border-t border-slate-200 flex flex-col gap-3">
                <!-- Options Row -->
                <div class="flex flex-wrap gap-2">
                    <!-- Option 1 -->
                    <label class="flex-1 min-w-[140px] cursor-pointer bg-white border border-slate-200 rounded-lg p-2.5 flex items-center gap-3 hover:border-indigo-300 transition-all select-none shadow-sm group-hover:border-indigo-200">
                        <input type="checkbox" id="mergeLines" class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-slate-700">合併斷句</span>
                            <span class="text-[10px] text-slate-400">串接成文章段落</span>
                        </div>
                    </label>

                    <!-- Option 2 -->
                    <label class="flex-1 min-w-[140px] cursor-pointer bg-white border border-slate-200 rounded-lg p-2.5 flex items-center gap-3 hover:border-indigo-300 transition-all select-none shadow-sm group-hover:border-indigo-200">
                        <input type="checkbox" id="removeSpaces" class="w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500">
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-slate-700">去除所有空格</span>
                            <span class="text-[10px] text-slate-400">適合純日文排版</span>
                        </div>
                    </label>
                </div>

                <!-- Action Button -->
                <button id="processBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 rounded-lg shadow-md shadow-indigo-200 flex items-center justify-center gap-2 active:scale-[0.99] transition-all">
                    <i data-lucide="sparkles" class="w-4 h-4"></i>
                    執行清理
                </button>
            </div>
        </div>

        <!-- Right Pane: Output -->
        <div class="flex-1 flex flex-col bg-white min-w-0">
            <!-- Pane Header -->
            <div class="px-5 py-3 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                <span class="text-sm font-semibold text-slate-600 flex items-center gap-2">
                    <i data-lucide="check-circle-2" class="w-4 h-4 text-emerald-500"></i>
                    整理結果
                </span>
                <div class="flex items-center gap-3 text-xs text-slate-400 font-mono">
                    <span id="lineCount">0 行</span>
                    <span class="w-px h-3 bg-slate-300"></span>
                    <span id="charCount">0 字元</span>
                </div>
            </div>

            <!-- Text Area Container -->
            <div class="relative flex-1 bg-slate-50/30">
                <textarea id="outputArea" readonly class="japanese-text w-full h-full p-5 resize-none focus:outline-none text-slate-800 text-base bg-transparent" placeholder="處理結果將顯示於此..."></textarea>
            </div>

            <!-- Right Footer: Actions -->
            <div class="p-4 bg-slate-50 border-t border-slate-200 flex gap-3">
                <button id="copyBtn" class="flex-1 bg-white hover:bg-slate-100 text-slate-700 border border-slate-300 font-medium py-2.5 rounded-lg shadow-sm flex items-center justify-center gap-2 transition-colors">
                    <i data-lucide="copy" class="w-4 h-4"></i>
                    複製
                </button>
                <button id="downloadBtn" class="flex-1 bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-2.5 rounded-lg shadow-md shadow-emerald-100 flex items-center justify-center gap-2 transition-colors">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    下載 .txt
                </button>
            </div>
        </div>

    </main>

    <script>
        // --- Init ---
        if (typeof lucide !== 'undefined' && lucide.createIcons) {
            lucide.createIcons();
        }

        // --- Elements ---
        const fileInput = document.getElementById('fileInput');
        const inputArea = document.getElementById('inputArea');
        const outputArea = document.getElementById('outputArea');
        const processBtn = document.getElementById('processBtn');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const clearBtn = document.getElementById('clearBtn');
        
        const mergeLinesCheckbox = document.getElementById('mergeLines');
        const removeSpacesCheckbox = document.getElementById('removeSpaces');
        
        const charCount = document.getElementById('charCount');
        const lineCount = document.getElementById('lineCount');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const dropZone = document.getElementById('dropZone');
        const dragOverlay = document.getElementById('dragOverlay');

        // --- Visual Helpers ---
        function updateOptionVisuals() {
            [mergeLinesCheckbox, removeSpacesCheckbox].forEach(cb => {
                const label = cb.parentElement;
                if (cb.checked) {
                    label.classList.add('border-indigo-500', 'bg-indigo-50');
                    label.classList.remove('border-slate-200', 'bg-white');
                } else {
                    label.classList.remove('border-indigo-500', 'bg-indigo-50');
                    label.classList.add('border-slate-200', 'bg-white');
                }
            });
        }
        
        [mergeLinesCheckbox, removeSpacesCheckbox].forEach(cb => {
            cb.addEventListener('change', updateOptionVisuals);
        });
        updateOptionVisuals();

        // --- File Handling ---
        function handleFile(file) {
            if (!file) return;
            loadingIndicator.classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = (event) => {
                inputArea.value = event.target.result;
                loadingIndicator.classList.add('hidden');
            };
            reader.readAsText(file);
        }

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
            fileInput.value = ''; 
        });

        clearBtn.addEventListener('click', () => {
            inputArea.value = '';
            outputArea.value = '';
            updateStats('');
        });

        // --- Drag & Drop ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        dropZone.addEventListener('dragenter', () => dragOverlay.classList.remove('hidden', 'flex'));
        dropZone.addEventListener('dragenter', () => dragOverlay.classList.add('flex'));
        
        dropZone.addEventListener('dragleave', (e) => {
            if (e.relatedTarget && !dropZone.contains(e.relatedTarget)) {
                dragOverlay.classList.add('hidden');
                dragOverlay.classList.remove('flex');
            }
        });

        dropZone.addEventListener('drop', (e) => {
            dragOverlay.classList.add('hidden');
            dragOverlay.classList.remove('flex');
            handleFile(e.dataTransfer.files[0]);
        });

        // --- Processing ---
        processBtn.addEventListener('click', () => {
            const rawText = inputArea.value;
            if (!rawText.trim()) {
                alert('請先輸入內容！');
                return;
            }

            const shouldMerge = mergeLinesCheckbox.checked;
            const removeSpaces = removeSpacesCheckbox.checked;
            let lines = rawText.split(/\r\n|\n|\r/);
            
            const timestampRegex = /^\d{1,2}:\d{1,2}:\d{1,2}[,.]\d{1,3}\s*-->\s*\d{1,2}:\d{1,2}:\d{1,2}[,.]\d{1,3}.*$/;
            const indexRegex = /^\d+$/;

            const cleanedLines = lines.map(line => {
                let text = line.trim();
                if (timestampRegex.test(text)) return null;
                if (indexRegex.test(text)) return null;
                if (text === 'WEBVTT') return null;
                if (text === '') return null;
                text = text.replace(/<[^>]*>/g, '');
                return text.trim();
            }).filter(line => line !== null);

            let resultText = '';
            if (shouldMerge) {
                resultText = cleanedLines.join(' ');
                resultText = resultText.replace(/\s+/g, ' ');
            } else {
                resultText = cleanedLines.join('\n');
            }

            if (removeSpaces) {
                if (shouldMerge) {
                    resultText = resultText.replace(/\s/g, '');
                } else {
                    resultText = resultText.split('\n').map(l => l.replace(/\s/g, '')).join('\n');
                }
            }

            outputArea.value = resultText;
            updateStats(resultText);
            
            // Subtle flash feedback
            outputArea.parentElement.classList.add('bg-indigo-50');
            setTimeout(() => outputArea.parentElement.classList.remove('bg-indigo-50'), 300);
        });

        function updateStats(text) {
            charCount.textContent = `${text.length} 字元`;
            const lines = text ? text.split('\n').length : 0;
            lineCount.textContent = `${lines} 行`;
        }

        // --- Export ---
        copyBtn.addEventListener('click', () => {
            if(!outputArea.value) return;
            outputArea.select();
            document.execCommand('copy');
            const originalHTML = copyBtn.innerHTML;
            copyBtn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> 已複製`;
            if (typeof lucide !== 'undefined') lucide.createIcons();
            setTimeout(() => {
                copyBtn.innerHTML = originalHTML;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }, 2000);
        });

        downloadBtn.addEventListener('click', () => {
            if(!outputArea.value) {
                alert("沒有內容可下載");
                return;
            }
            const blob = new Blob([outputArea.value], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cleaned_japanese_text.txt';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        });
    </script>
</body>
</html>